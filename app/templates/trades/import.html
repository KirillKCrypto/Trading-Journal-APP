{% extends "base.html" %}
{% block head %}
<style>
    .btn-primary {
        background-color: var(--theme-color);
    }
    .btn-primary:hover {
        background-color: #5c636a;
    }
    .btn-secondary {
        background-color: #444;
    }
    .btn-success {
        background-color: #28a745;
    }
    .btn-success:hover {
        background-color: #218838;
    }
    .form-container {
        max-width: 800px;
        margin: 0 auto;
    }
    .info-text {
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    .instruction-step {
        background: #f8f9fa;
        border-left: 4px solid var(--theme-color);
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 0 4px 4px 0;
    }
    body.dark-mode .instruction-step {
        background: #2d3748;
        border-left-color: var(--theme-color);
    }
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    .template-section {
        background: #e7f3ff;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
        border: 2px dashed #0d6efd;
    }
    body.dark-mode .template-section {
        background: #1a365d;
        border-color: #4299e1;
    }
    .copy-btn {
        background: var(--theme-color);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .copy-btn:hover {
        background: #5c636a;
        transform: translateY(-1px);
    }
    .template-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        margin: 15px 0;
    }
</style>
{% endblock %}
{% block title %}–ò–º–ø–æ—Ä—Ç —Å–¥–µ–ª–æ–∫ –∏–∑ Notion{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="form-container">
        <h2 class="mb-4">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–¥–µ–ª–∫–∏ –∏–∑ Notion</h2>

        <!-- –°–µ–∫—Ü–∏—è —à–∞–±–ª–æ–Ω–∞ -->
        <div class="template-section">
            <h4 class="mb-3">üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç —Å –Ω–∞—à–∏–º —à–∞–±–ª–æ–Ω–æ–º</h4>

            <p class="mb-3">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ—Ç–æ–≤—ã–π —à–∞–±–ª–æ–Ω –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É –º–≥–Ω–æ–≤–µ–Ω–Ω–æ:</p>

            <div class="template-actions">
                <a href="https://www.notion.so/Trading-Journal-29f71935512181a4a3eae231f4479528?source=copy_link"
                   target="_blank"
                   class="btn btn-success">
                    üìã –û—Ç–∫—Ä—ã—Ç—å —à–∞–±–ª–æ–Ω –≤ Notion
                </a>
                <button class="copy-btn" onclick="copyTemplateLink(this)">
                    üìé –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                </button>
            </div>

            <div class="mb-3">
                <h6>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω:</h6>
                <ol class="mb-0">
                    <li>–ù–∞–∂–º–∏—Ç–µ "–û—Ç–∫—Ä—ã—Ç—å —à–∞–±–ª–æ–Ω –≤ Notion" –≤—ã—à–µ</li>
                    <li>–í –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –Ω–∞–∂–º–∏—Ç–µ <strong>"Duplicate"</strong></li>
                    <li>–®–∞–±–ª–æ–Ω –ø–æ—è–≤–∏—Ç—Å—è –≤ –≤–∞—à–µ–º —Ä–∞–±–æ—á–µ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ</li>
                    <li>–ù–∞—á–Ω–∏—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–≤–æ–∏ —Å–¥–µ–ª–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü—É</li>
                    <li>–î–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–∏–∂–µ</li>
                </ol>
            </div>
        </div>

        <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="mb-4">
            <div class="instruction-step">
                <h5>üìã –®–∞–≥ 1: –°–æ–∑–¥–∞–π—Ç–µ Integration –≤ Notion</h5>
                <p class="mb-1">1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ <a href="https://www.notion.so/my-integrations" target="_blank">My Integrations</a></p>
                <p class="mb-1">2. –ù–∞–∂–º–∏—Ç–µ "New integration"</p>
                <p class="mb-1">3. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Trade Importer")</p>
                <p class="mb-1">4. –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π Workspace</p>
                <p class="mb-0">5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ "Internal Integration Token" (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å <code>ntn_</code>)</p>
            </div>

            <div class="instruction-step">
                <h5>üîë –®–∞–≥ 2: –ü–æ–ª—É—á–∏—Ç–µ Database ID</h5>
                <p class="mb-1">1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à—É –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –≤ Notion</p>
                <p class="mb-1">2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID –∏–∑ URL:</p>
                <code>https://www.notion.so/workspace/<strong class="text-primary">a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6</strong>?...</code>
                <p class="mb-0 mt-1">(—ç—Ç–æ 32-—Å–∏–º–≤–æ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ–∂–¥—É / –∏ ?)</p>
            </div>

            <div class="instruction-step">
                <h5>üîó –®–∞–≥ 3: –î–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø Integration</h5>
                <p class="mb-1">1. –í –≤–∞—à–µ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–∂–º–∏—Ç–µ "..." –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É</p>
                <p class="mb-1">2. –í—ã–±–µ—Ä–∏—Ç–µ "Add connections" –∏–ª–∏ "Connections"</p>
                <p class="mb-0">3. –ù–∞–π–¥–∏—Ç–µ –≤–∞—à–µ integration –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –µ–≥–æ</p>
            </div>
        </div>

        <form action="{{ url_for('trades.import_notion') }}" method="POST">
            <div class="mb-3">
                <label for="notion_token" class="form-label required-field">
                    Notion Integration Token
                </label>
                <div class="input-group">
                    <input type="password" class="form-control" id="notion_token" name="notion_token"
                           placeholder="ntn_xxxxxxxxxxxxxxxxxxxxxxxx"
                           value="{{ request.form.notion_token or '' }}" required>
                    <button type="button" class="btn btn-outline-secondary" onclick="toggleTokenVisibility()">
                        üëÅÔ∏è
                    </button>
                </div>
                <div class="info-text">
                    –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å <code>ntn_</code>.
                </div>
            </div>

            <div class="mb-3">
                <label for="database_id" class="form-label required-field">
                    Database ID
                </label>
                <input type="text" class="form-control" id="database_id" name="database_id"
                       placeholder="a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
                       value="{{ request.form.database_id or '' }}" required>
                <div class="info-text">
                    32-—Å–∏–º–≤–æ–ª—å–Ω—ã–π ID –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
                </div>
            </div>

            <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-primary">
                    üöÄ –ù–∞—á–∞—Ç—å –∏–º–ø–æ—Ä—Ç
                </button>
                <a href="{{ url_for('trades.index') }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–¥–µ–ª–∫–∞–º</a>
            </div>
        </form>
    </div>
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
function showTempMessage(message, type = 'success') {
    const messageEl = document.createElement('div');
    messageEl.textContent = message;
    messageEl.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : '#dc3545'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 10000;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
    `;

    document.body.appendChild(messageEl);

    setTimeout(() => {
        messageEl.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(messageEl);
        }, 300);
    }, 3000);
}

// –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
async function copyTemplateLink(button) {
    const templateLink = "https://www.notion.so/Trading-Journal-29f71935512181a4a3eae231f4479528?source=copy_link";

    const originalText = button.innerHTML;

    try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ"
        button.innerHTML = '‚è≥ –ö–æ–ø–∏—Ä—É–µ–º...';
        button.disabled = true;

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π Clipboard API
        await navigator.clipboard.writeText(templateLink);

        // –£—Å–ø–µ—Ö
        button.innerHTML = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        showTempMessage('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        }, 2000);

    } catch (error) {
        // –û—à–∏–±–∫–∞ - –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', error);

        button.innerHTML = '‚ùå –û—à–∏–±–∫–∞';
        showTempMessage('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏', 'error');

        // –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
        setTimeout(() => {
            button.innerHTML = 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é';
            button.disabled = false;

            // –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∫–ª–∏–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            button.onclick = () => showManualCopy(templateLink, button);
        }, 2000);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—à–∏–±–∫–µ)
function showManualCopy(link, button) {
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    `;

    modal.innerHTML = `
        <div style="
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
            <h4 style="margin: 0 0 16px 0; color: #333;">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é</h4>
            <input type="text"
                   value="${link}"
                   readonly
                   style="
                       width: 100%;
                       padding: 12px;
                       border: 2px solid #ddd;
                       border-radius: 6px;
                       font-size: 14px;
                       margin-bottom: 16px;
                   "
                   onclick="this.select()">
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="this.closest('.manual-copy-modal').remove()"
                        style="
                            padding: 10px 20px;
                            border: 1px solid #ddd;
                            background: #f8f9fa;
                            border-radius: 6px;
                            cursor: pointer;
                        ">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    `;

    modal.querySelector('input').select();
    modal.classList.add('manual-copy-modal');
    document.body.appendChild(modal);

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    button.innerHTML = 'üìé –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É';
    button.onclick = (e) => copyTemplateLink(button);
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞
function toggleTokenVisibility(button) {
    const tokenInput = document.getElementById('notion_token');

    if (tokenInput.type === 'password') {
        tokenInput.type = 'text';
        button.textContent = 'üôà –°–∫—Ä—ã—Ç—å';
    } else {
        tokenInput.type = 'password';
        button.textContent = 'üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å';
    }
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Database ID
document.getElementById('database_id')?.addEventListener('input', function(e) {
    let value = e.target.value;
    value = value.replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);
    e.target.value = value;
});

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
document.getElementById('notion_token')?.addEventListener('input', function(e) {
    let value = e.target.value;
    value = value.replace(/\s/g, '');
    e.target.value = value;
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
document.querySelector('form')?.addEventListener('submit', function(e) {
    const token = document.getElementById('notion_token').value;
    const dbId = document.getElementById('database_id').value;

    if (!token || !dbId) {
        e.preventDefault();
        showTempMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è', 'error');
        return;
    }

    if (!token.startsWith('ntn_')) {
        if (!confirm('–¢–æ–∫–µ–Ω –æ–±—ã—á–Ω–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "ntn_". –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ç–æ–∫–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω?')) {
            e.preventDefault();
            return;
        }
    }

    if (dbId.length !== 32) {
        if (!confirm('Database ID –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 32 —Å–∏–º–≤–æ–ª–∞. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ ID –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω?')) {
            e.preventDefault();
            return;
        }
    }
});
</script>
{% endblock %}
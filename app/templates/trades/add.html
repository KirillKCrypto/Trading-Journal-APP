{% extends "base.html" %}
{% block title %}–î–æ–±–∞–≤–∏—Ç—å —Å–¥–µ–ª–∫—É{% endblock %}
{% block head %}
<style>
    .screenshot-upload {
            display: none;
        }
    .active-btn {
            border: 2px solid #198754 !important;
            font-weight: bold;
        }
    .preview-img {
            max-width: 200px;
            max-height: 150px;
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            object-fit: contain;
        }
    .date-input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    transition: all 0.2s ease;
    }
    .btn-outline-success {
    border: 1px solid var(--theme-color);
    color: black;
    }
    .btn-outline-success:hover {
    background-color: var(--theme-color);
    }
    .btn-success {
    background-color: var(--theme-color);
    }
    .btn-success:hover {
    background-color: #121212;
    }
</style>
{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å–¥–µ–ª–∫–∏</h2>
    <form action="{{ url_for('trades.add_trade') }}" method="POST" enctype="multipart/form-data" class="row g-3">

        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è -->
        <div class="col-md-4">
            <label for="date" class="form-label">üìÖ –î–∞—Ç–∞</label>
            <input type="date"
                   class="form-control date-input"
                   id="date"
                   name="date"
                   required
                   max="">
        </div>
        <div class="col-md-4">
            <label for="symbol" class="form-label">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</label>
            <input type="text" class="form-control" name="symbol" required>
        </div>

        <div class="col-md-4">
            <label for="session" class="form-label">–°–µ—Å—Å–∏—è</label>
            <select class="form-select" name="session" required>
                <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é</option>
                {% for s in sessions %}
                <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-4">
            <label for="position" class="form-label">–ü–æ–∑–∏—Ü–∏—è</label>
            <select class="form-select" name="position" required>
                <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∑–∏—Ü–∏—é</option>
                {% for p in positions %}
                <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-4">
            <label for="bias" class="form-label">Bias</label>
            <select class="form-select" name="bias" required>
                <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ Bias</option>
                <option value="Long">Long</option>
                <option value="Short">Short</option>
            </select>
        </div>

        <div class="col-md-4">
            <label for="logic" class="form-label">–õ–æ–≥–∏–∫–∞ –≤—Ö–æ–¥–∞</label>
            <select class="form-select" name="logic" required>
                <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–≥–∏–∫—É –≤—Ö–æ–¥–∞</option>
                {% for l in logics %}
                <option value="{{ l }}">{{ l }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-12">
            <label for="entry_details" class="form-label">–î–µ—Ç–∞–ª–∏ –≤—Ö–æ–¥–∞</label>
            <textarea class="form-control" name="entry_details" rows="2"></textarea>
        </div>

        <div class="col-md-4">
            <label for="risk"  class="form-label">–†–∏—Å–∫ (%)</label>
            <input type="number" step="0.1" class="form-control" name="risk" required>
        </div>

        <div class="col-md-4">
            <label for="rr" class="form-label">RR</label>
            <input type="number" step="0.01" class="form-control" name="rr">
        </div>

        <div class="col-md-4">
            <label for="result_type" class="form-label">–†–µ–∑—É–ª—å—Ç–∞—Ç</label>
            <select class="form-select" name="result_type" required>
                <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç</option>
                {% for r in result_types %}
                <option value="{{ r }}">{{ r }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-12">
            <label for="mistakes" class="form-label">–û—à–∏–±–∫–∏</label>
            <textarea class="form-control" name="mistakes" rows="2"></textarea>
        </div>

        <div class="col-12">
            <label for="notes" class="form-label">–ó–∞–º–µ—Ç–∫–∏</label>
            <textarea class="form-control" name="notes" rows="2"></textarea>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ -->
        <div class="col-12">
            <label class="form-label">–°–∫—Ä–∏–Ω—à–æ—Ç—ã –ø–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞–º</label>
            <div class="btn-group mb-3" role="group">
                <button type="button" class="btn btn-outline-success" onclick="showUploader('1h', this)">1H</button>
                <button type="button" class="btn btn-outline-success" onclick="showUploader('5m', this)">5M</button>
                <button type="button" class="btn btn-outline-success" onclick="showUploader('3m', this)">3M</button>
            </div>
        </div>

        <!-- –ü–æ–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º -->
        <div class="col-md-6 screenshot-upload" id="upload-1h">
            <label for="screenshot_1h" class="form-label">–°–∫—Ä–∏–Ω—à–æ—Ç 1H</label>
            <input type="file" class="form-control" name="screenshot_1h" accept="image/*" onchange="previewImage(this, 'preview-1h')">
            <img id="preview-1h" class="preview-img" style="display: none;" />
        </div>

        <div class="col-md-6 screenshot-upload" id="upload-5m">
            <label for="screenshot_5m" class="form-label">–°–∫—Ä–∏–Ω—à–æ—Ç 5M</label>
            <input type="file" class="form-control" name="screenshot_5m" accept="image/*" onchange="previewImage(this, 'preview-5m')">
            <img id="preview-5m" class="preview-img" style="display: none;" />
        </div>

        <div class="col-md-6 screenshot-upload" id="upload-3m">
            <label for="screenshot_3m" class="form-label">–°–∫—Ä–∏–Ω—à–æ—Ç 3M</label>
            <input type="file" class="form-control" name="screenshot_3m" accept="image/*" onchange="previewImage(this, 'preview-3m')">
            <img id="preview-3m" class="preview-img" style="display: none;" />
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
        <div class="col-12">
            <button type="submit" class="btn btn-success mt-3">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–¥–µ–ª–∫—É</button>
            <a href="{{ url_for('trades.index') }}" class="btn btn-secondary mt-3">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>

<script>
    function showUploader(tf, btn) {
        document.querySelectorAll('.screenshot-upload').forEach(div => div.style.display = 'none');
        document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active-btn'));
        document.getElementById(`upload-${tf}`).style.display = 'block';
        btn.classList.add('active-btn');
    }

    function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        } else {
            preview.style.display = 'none';
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('date');
    if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.max = today;

        // –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        dateInput.addEventListener('change', function() {
            if (this.value > today) {
                this.setCustomValidity('–ù–µ–ª—å–∑—è –≤—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É –≤ –±—É–¥—É—â–µ–º');
                this.reportValidity();
            } else {
                this.setCustomValidity('');
            }
        });
    }
});

// –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
document.querySelector('form')?.addEventListener('submit', function(e) {
    const dateInput = document.getElementById('date');
    const today = new Date().toISOString().split('T')[0];

    if (dateInput && dateInput.value > today) {
        e.preventDefault();
        dateInput.focus();
        dateInput.setCustomValidity('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –Ω–µ –ø–æ–∑–∂–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π');
        dateInput.reportValidity();
    }
});
</script>
{% endblock %}
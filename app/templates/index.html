{% extends "base.html" %}
{% block head %}
{% block scripts %}
<script>
    // –ü–µ—Ä–µ–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ Flask –≤ JS
    window.flaskData = {
        currentDate: "{{ current_date }}",
        dateFrom: "{{ filters.date_from or '' }}",
        dateTo: "{{ filters.date_to or '' }}",
        deleteMultipleUrl: "{{ url_for('trades.delete_multiple_trades') }}"
    };
</script>
<script defer src="{{ url_for('static', filename='js/index.js') }}"></script>
{% endblock %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
{% endblock %}

{% block title %}–¢–æ—Ä–≥–æ–≤—ã–π –∂—É—Ä–Ω–∞–ª —Å–¥–µ–ª–æ–∫{% endblock %}

{% block content %}
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
      <h1 class="mb-2 mb-md-0">–¢–æ—Ä–≥–æ–≤—ã–π –∂—É—Ä–Ω–∞–ª —Å–¥–µ–ª–æ–∫</h1>
      <div class="index-buttons">
          <a href="{{ url_for('trades.add_trade') }}" class="btn btn-primary me-2 mb-2 mb-md-0">–î–æ–±–∞–≤–∏—Ç—å —Å–¥–µ–ª–∫—É</a>
          <a href="{{ url_for('trades.import_notion') }}" class="btn btn-success mb-2 mb-md-0">–ò–º–ø–æ—Ä—Ç –∂—É—Ä–Ω–∞–ª–∞ Notion</a>
      </div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <form method="get" id="filter-form" class="flex-grow-1 me-3">
      <div class="row g-2 align-items-end">
        {% set filter_fields = {'symbol': '–í—Å–µ —Å–∏–º–≤–æ–ª—ã', 'session': '–í—Å–µ —Å–µ—Å—Å–∏–∏', 'position': '–í—Å–µ –ø–æ–∑–∏—Ü–∏–∏', 'result_type': '–í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã'} %}
        {% for field, label in filter_fields.items() %}
          <div class="col-6 col-md">
              <select name="{{ field }}" class="form-select form-select-sm {% if filters[field] %}active-filter{% endif %}">
              <option value="">{{ label }}</option>
              {% for val in unique[field ~ 's'] %}
                <option value="{{ val }}" {% if filters[field] == val|string %}selected{% endif %}>{{ val }}</option>
              {% endfor %}
              </select>
          </div>
        {% endfor %}

        <div class="col-6 col-md">
          <input
            type="text"
            id="date_from"
            name="date_from"
            class="form-control form-control-sm"
            placeholder="–î–∞—Ç–∞ —Å"
            value="{{ filters.date_from or '' }}"
            autocomplete="off"
          >
        </div>
        <div class="col-6 col-md">
          <input
            type="text"
            id="date_to"
            name="date_to"
            class="form-control form-control-sm"
            placeholder="–î–∞—Ç–∞ –ø–æ"
            value="{{ filters.date_to or '' }}"
            autocomplete="off"
          >
        </div>

        <div class="col-auto">
          <a href="{{ url_for('trades.index') }}" class="btn btn-sm btn-outline-secondary">‚úñ</a>
        </div>
      </div>
    </form>

    <button id="deleteSelected" class="btn btn-danger ms-2" style="display: none;">
      üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
    </button>
  </div>

  {% if trades %}
  <div class="d-flex justify-content-end align-items-center gap-3 mb-3 flex-wrap values-container">
      <div class="px-3 py-2 bg-light border rounded shadow-sm text-dark">
          <strong>avg RR:</strong> {{ "%.2f"|format(rr_avg) }}
      </div>
      <div class="px-3 py-2 bg-light border rounded shadow-sm text-dark">
          <strong>sum RR:</strong> {{ "%.2f"|format(rr_sum) }}
      </div>
  </div>

  <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle bg-white shadow-sm small text-center">
        <thead class="table-light text-dark">
          <tr>
            <th width="40">
              <input type="checkbox" id="selectAll" class="form-check-input">
            </th>
            <th>#</th>
            <th>üìÖ</th>
            <th>üí±</th>
            <th>üïê</th>
            <th>üìà</th>
            <th>Bias</th>
            <th>Risk</th>
            <th>RR</th>
            <th>PnL</th>
            <th>‚ö°</th>
            <th>üñºÔ∏è</th>
          </tr>
        </thead>
        <tbody>
          {% for trade in trades %}
          <tr class="clickable-row" style="cursor:pointer;">
            <td onclick="event.stopPropagation()">
              <input type="checkbox" class="form-check-input trade-checkbox" value="{{ trade.id }}">
            </td>
            <td onclick="window.location='{{ url_for('trades.trade_detail', trade_id=trade.id) }}'">{{ loop.index }}</td>
            <td onclick="window.location='{{ url_for('trades.trade_detail', trade_id=trade.id) }}'">{{ trade.date.strftime('%d.%m') }}</td>
            <td onclick="window.location='{{ url_for('trades.trade_detail', trade_id=trade.id) }}'">{{ trade.symbol }}</td>
            <td onclick="window.location='{{ url_for('trades.trade_detail', trade_id=trade.id) }}'">{{ trade.session[0:2] }}</td>
            <td onclick="window.location='{{ url_for('trades.trade_detail', trade_id=trade.id) }}'">{{ trade.position if trade.position else '' }}</td>
            <td onclick="window.location='{{ url_for('trades.trade_detail', trade_id=trade.id) }}'">{{ trade.bias }}</td>
            <td onclick="window.location='{{ url_for('trades.trade_detail', trade_id=trade.id) }}'">{{ '%.1f' | format(trade.risk * 100) if trade.risk is not none else '-' }}%</td>
            <td onclick="window.location='{{ url_for('trades.trade_detail', trade_id=trade.id) }}'">{{ trade.rr if trade.rr is not none else '-' }}</td>
            <td onclick="window.location='{{ url_for('trades.trade_detail', trade_id=trade.id) }}'">
              {% if trade.rr is not none and trade.risk is not none %}
                <span class="{% if trade.rr > 0 %}text-success{% else %}text-danger{% endif %}">
                  {{ "%.2f" | format(trade.rr * trade.risk * 100) }}%
                </span>
              {% else %}
                -
              {% endif %}
            </td>
            <td onclick="window.location='{{ url_for('trades.trade_detail', trade_id=trade.id) }}'">
              {% if trade.result_type == 'TP' %}
                <span class="badge bg-success">TP</span>
              {% elif trade.result_type == 'SL' %}
                <span class="badge bg-danger">SL</span>
              {% elif trade.result_type == 'BE' %}
                <span class="badge bg-secondary">BE</span>
              {% else %}
                <span class="badge bg-light text-dark">?</span>
              {% endif %}
            </td>
            <td onclick="window.location='{{ url_for('trades.trade_detail', trade_id=trade.id) }}'">
              {% set screenshot = trade.screenshot_1h_path or trade.screenshot_5m_path or trade.screenshot_3m_path %}
              {% if screenshot %}
                <a id="screenshot-img" href="{{ url_for('static', filename=screenshot) }}" target="_blank" rel="noopener noreferrer">
                  <img src="{{ url_for('static', filename=screenshot) }}" alt="Screenshot" class="screenshot-thumb" />
                </a>
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
  </div>
  {% else %}
  <p class="text-muted">–ù–µ—Ç —Å–¥–µ–ª–æ–∫, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞.</p>
  {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div class="modal fade modal-dark-theme" id="deleteConfirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å <span id="selectedCount">0</span> –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫?</p>
        <p class="text-muted small">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-danger" id="confirmDelete">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}